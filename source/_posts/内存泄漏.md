---
title: 内存泄漏
date: 2023-08-15 13:10:47
categories:
- C++
- 内存泄漏
tags:
- C++
- 内存泄漏
- 面试问题
---

# 什么是内存泄漏
内存泄漏是指在程序运行过程中，分配的内存空间没有被正确释放或回收的情况。这种情况下，程序将持续消耗内存资源，导致内存使用量逐渐增加，最终可能导致程序崩溃或性能下降。

# 造成内存泄漏的原因
- 未使用delete或delete[]释放动态分配的内存：当使用new运算符动态分配内存后，应该在不再使用时使用相应的delete或delete[]运算符释放内存。
- 函数中的资源管理错误：如果在函数中分配了内存，并且在函数返回前没有正确释放它，就会导致内存泄漏。
- 异常处理不完整：如果在捕获异常之后没有正确释放相关资源，就可能出现内存泄漏。

# 如何预防和避免内存泄漏的方法  
- 使用智能指针（如std::shared_ptr、std::unique_ptr）来管理动态分配的内存，以自动进行内存释放。
- 遵循RAII原则（资源获取即初始化），在对象的构造函数中申请资源，在析构函数中释放资源。
- 谨慎使用动态内存分配，尽量避免频繁使用new/delete。
- 仔细检查代码逻辑，确保每次分配内存后都有相应的释放操作。
- 使用内存泄漏检测工具来帮助发现和解决内存泄漏问题，如Valgrind、Dr. Memory等。

# 如何定位内存泄漏的位置
- 根据原理，我们可以先review自己的代码，利用"查找"功能，查询new与delete，看看内存的申请与释放是不是成对释放的，这使你迅速发现一些逻辑较为简单的内存泄露情况。
- 如果依旧发生内存泄露，可以通过记录申请与释放的对象数目是否一致来判断。在类中追加一个静态变量 static int count;在构造函数中执行count++;在析构函数中执行count--;，通过在程序结束前将所有类析构，之后输出静态变量，看count的值是否为0，如果为0,则问题并非出现在该处，如果不为0，则是该类型对象没有完全释放。
- 检查类中申请的空间是否完全释放，尤其是存在继承父类的情况，看看子类中是否调用了父类的析构函数，有可能会因为子类析构时没有是否父类中申请的内存空间。
- 对于函数中申请的临时空间，认真检查，是否存在提前跳出函数的地方没有释放内存。
- 日志记录和统计信息：通过日志记录和统计信息，可以追踪内存分配和释放的情况。可以在分配内存和释放内存的地方添加日志，记录相关信息，包括内存地址、分配大小、释放操作等。通过分析这些日志，可以找出是否有未释放的内存资源。
- 使用内存调试工具：使用专门的内存调试工具可以帮助您检测和定位内存泄漏问题。例如，Valgrind、Dr. Memory、Intel Inspector等工具可以提供详细的内存分配和释放信息，帮助您确定哪些内存资源未被正确释放。
- 内存剖析工具：使用内存剖析工具可以统计程序中各个部分的内存使用情况，从而帮助您找到内存泄漏的位置。例如，在Linux环境下，可以使用工具像Massif、Heaptrack等。
- 逐步调试：使用调试器逐步调试程序，关注内存分配和释放的过程。通过观察内存的分配和释放情况，可以初步定位可能的内存泄漏位置。

**补充**：
对于Windows
1. 使用Windows自带的工具
    - Task Manager（任务管理器）：打开任务管理器并切换到“性能”选项卡，观察内存利用率的变化情况。如果发现内存占用不断增加，可能存在内存泄漏。
    - Resource Monitor（资源监视器）：资源监视器提供了更详细的系统资源使用情况，包括内存、CPU、磁盘等。可以通过查看内存相关的信息，如内存占用、内存分页等，来判断是否有内存泄漏情况。
2. 使用性能监测工具
    - Windows Performance Monitor（性能监视器）：性能监视器可以实时监测和记录系统的性能数据，包括内存使用情况、进程内存分配等。可以通过创建性能计数器来监测特定进程或关键指标的变化，帮助确定是否存在内存泄漏问题。
    - DebugDiag（调试诊断工具）：DebugDiag是Windows平台上的一种常用调试工具，可以用于收集应用程序的崩溃、内存泄漏等信息。可以配置DebugDiag以捕获应用程序或进程的内存快照，然后分析生成的报告，找出内存泄漏的根源。
3. 使用第三方工具
    - Process Explorer（进程资源查看器）：Process Explorer是一款功能强大的系统工具，可以用于监视和分析进程的资源使用情况，包括内存、文件句柄等。可以使用Process Explorer定位到占用大量内存的进程，并查看相关的模块或堆栈信息，以找出可能的内存泄漏问题。
    - WinDbg（Windows调试器）：WinDbg是一个强大的Windows调试器，可以用于分析应用程序的崩溃、内存泄漏等问题。通过加载应用程序的符号表和执行调试命令，可以定位到内存泄漏的具体位置并进行调试。



# 对于大型线上运行的项目采用的处理办法
- 监控系统：建立一个稳定的监控系统，通过不断收集和记录内存使用情况，以及其他关键指标（如CPU利用率、请求处理时间等）来监测系统的性能和资源使用情况。当内存使用量异常增长时，可以及时发现。
- 长期稳定版本：在大型项目中，通常会有长期稳定版本运行在线上环境。如果发现内存泄漏问题，首先应该检查最近哪个版本引入了内存泄漏问题。通过版本管理工具可以追踪代码变更，然后对比不同版本之间的区别，找出可能引起内存泄漏的代码段。
- 日志分析：详细的日志记录对于排查内存泄漏问题非常重要。可以通过添加详细的日志信息，包括内存分配和释放的操作，以及相关的上下文信息。通过分析日志，可以找出某些特定操作或场景下的内存泄漏问题。
- 复现和测试：尽可能复现内存泄漏问题，并进行有针对性的测试。通过模拟真实场景或者特定业务流程，触发内存泄漏的条件。在开发或测试环境中进行调试和排查，可以更方便地定位问题，并提供修复方案。
- 动态追踪工具：使用动态追踪工具来分析程序运行时的内存分配和释放情况。这些工具可以提供详细的调用栈信息、内存分配堆栈跟踪等，帮助定位内存泄漏问题。例如，对于Linux环境，可以使用工具像Valgrind、GDB等。
- 性能剖析工具：使用性能剖析工具来获取程序的性能数据，包括内存占用和调用堆栈信息。通过分析这些数据，可以找出可能的内存泄漏区域。例如，对于C++项目，可以使用工具像Google Performance Tools、Intel VTune等。




